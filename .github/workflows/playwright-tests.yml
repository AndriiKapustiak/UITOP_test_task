name: Playwright Tests

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:  # Allow manual trigger
  schedule:
    # Run tests daily at 2 AM UTC
    - cron: '0 2 * * *'

jobs:
  test:
    name: Run Playwright Tests
    runs-on: ubuntu-latest
    container:
      image: mcr.microsoft.com/playwright:v1.58.2-noble
    
    strategy:
      fail-fast: false
      matrix:
        browser: [chromium, firefox, webkit]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run Playwright tests on ${{ matrix.browser }}
        run: npx playwright test --project=${{ matrix.browser }} --reporter=html,list
        continue-on-error: true

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.browser }}
          path: |
            test-results/
            playwright-report/
          retention-days: 30

      - name: Upload error logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: error-logs-${{ matrix.browser }}
          path: test-results/error-logs/
          retention-days: 30
          if-no-files-found: ignore

  publish-report:
    name: Publish Test Report to GitHub Pages
    needs: test
    runs-on: ubuntu-latest
    if: always()
    permissions:
      contents: write
      pages: write
      id-token: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all test results
        uses: actions/download-artifact@v4
        with:
          path: all-test-results

      - name: Merge HTML reports
        run: |
          mkdir -p merged-report
          # Copy the first browser's report as base
          if [ -d "all-test-results/test-results-chromium/playwright-report" ]; then
            cp -r all-test-results/test-results-chromium/playwright-report/* merged-report/
          fi
          
          # Create index page with links to all browser reports
          cat > merged-report/index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
            <title>Alynea Playwright Test Results</title>
            <style>
              body { font-family: Arial, sans-serif; margin: 40px; background: #f5f5f5; }
              h1 { color: #333; }
              .browser-links { display: flex; gap: 20px; margin: 30px 0; }
              .browser-card { 
                background: white; 
                padding: 20px; 
                border-radius: 8px; 
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                text-decoration: none;
                color: #333;
                transition: transform 0.2s;
              }
              .browser-card:hover { transform: translateY(-2px); }
              .timestamp { color: #666; font-size: 14px; }
            </style>
          </head>
          <body>
            <h1>ğŸ­ Alynea Playwright Test Results</h1>
            <p class="timestamp">Generated: $(date -u +"%Y-%m-%d %H:%M:%S UTC")</p>
            <div class="browser-links">
              <a href="chromium/index.html" class="browser-card">
                <h2>ğŸŒ Chromium</h2>
                <p>View test results</p>
              </a>
              <a href="firefox/index.html" class="browser-card">
                <h2>ğŸ¦Š Firefox</h2>
                <p>View test results</p>
              </a>
              <a href="webkit/index.html" class="browser-card">
                <h2>ğŸ§­ WebKit</h2>
                <p>View test results</p>
              </a>
            </div>
            <h2>ğŸ“Š Test Summary</h2>
            <p>Click on a browser above to view detailed test results.</p>
          </body>
          </html>
          EOF

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: merged-report

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Comment PR with report link
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '## ğŸ­ Playwright Test Results\n\nâœ… Tests completed! View the full report at: ${{ steps.deployment.outputs.page_url }}'
            })

